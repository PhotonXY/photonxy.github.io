<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Raum-Logbuch v2</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Auth/Login Overlay -->
  <div id="auth" class="auth-screen" aria-modal="true" role="dialog">
    <div class="auth-hero">LogOne</div>
    <div class="auth-card">
      <h2 class="auth-title">Anmelden</h2>
      <p class="auth-sub">Mit Benutzername und Passwort anmelden.</p>
      <div class="row">
        <div class="grow">
          <label for="loginUser">Benutzer</label>
          <input id="loginUser" type="text" placeholder="z. B. Demo Admin" autocomplete="username" list="loginUsers" />
          <datalist id="loginUsers"></datalist>
        </div>
      </div>
      <div class="row">
        <div class="grow">
          <label for="loginPass">Passwort</label>
          <div class="input-group">
            <input id="loginPass" type="password" placeholder="Passwort" autocomplete="current-password" />
            <button id="btnEye" class="eye-btn" title="Passwort ein-/ausblenden">üëÅ</button>
          </div>
          <small class="hint">Demo-Passwort: ‚Äûtest‚Äú</small>
        </div>
      </div>
      <div class="auth-footer">
        <label><input type="checkbox" id="remember"/> Eingeloggt bleiben</label>
        <div class="auth-actions">
          <button id="btnQuickAdmin" class="ghost">Admin</button>
          <button id="btnQuickPruefer" class="ghost">Pruefer</button>
          <button id="btnQuickUser" class="ghost">User</button>
          <button id="btnDemo" class="ghost">Demo Start</button>
          <button id="btnLogin">Anmelden</button>
        </div>
      </div>
      <div id="loginMsg" class="muted" role="status"></div>
    </div>
  </div>

  <header class="appbar">
    <div class="brand">LogOne</div>
    <div class="controls">
      <div class="row">
        <label>Datum</label>
        <input id="appDate" type="date" />
      </div>
      <div class="row" id="profileBox" style="display:none">
        <label>Profil</label>
        <div class="user-badge" id="badge">‚Äî</div>
      </div>
      <button id="btnOpenLogin" class="ghost">Anmelden</button>
      <button id="btnLogout" class="ghost" style="display:none">Logout</button>
      <button id="themeToggle" class="theme-toggle" aria-label="Theme umschalten">
        <span class="theme-icon" aria-hidden="true">
          <!-- Startsymbol: Sonne (Stroke-Only) -->
          <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="4"></circle>
            <path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"></path>
          </svg>
        </span>
      </button>
    </div>
  </header>

  <main class="grid resp" id="mainGrid">
    <section class="card" data-view="dashboard" data-card="dashboard" draggable="true">
      <h2 class="section-title">Dashboard</h2>
      <div class="tabs" id="anaTabs">
        <button class="tab small active" data-ana="daily">T√§glich</button>
        <button class="tab small" data-ana="weekly">W√∂chentlich</button>
        <button class="tab small" data-ana="monthly">Monatlich</button>
      </div>
      <div class="ana-panel" data-ana-panel="daily">
        <div class="bar">
          <label>Datum</label>
          <input id="anaDate" type="date" />
        </div>
        <div class="kpi-grid" id="kpiDaily"></div>
        <div class="table-wrap"><table id="tblDailyTop">
          <thead><tr><th>Raum</th><th>T√§tigkeit</th><th>Status</th></tr></thead>
          <tbody></tbody></table></div>
      </div>
      <div class="ana-panel" data-ana-panel="weekly" style="display:none">
        <div class="bar">
          <label>Woche</label>
          <input id="anaWeek" type="week" />
        </div>
        <div class="kpi-grid" id="kpiWeekly"></div>
        <div class="table-wrap"><table id="tblWeeklyTop">
          <thead><tr><th>Raum</th><th>T√§tigkeit</th><th>Erledigt/Offen</th></tr></thead>
          <tbody></tbody></table></div>
      </div>
      <div class="ana-panel" data-ana-panel="monthly" style="display:none">
        <div class="bar">
          <label>Monat</label>
          <input id="anaMonth" type="month" />
        </div>
        <div class="kpi-grid" id="kpiMonthly"></div>
        <div class="table-wrap"><table id="tblMonthlyTop">
          <thead><tr><th>Raum</th><th>T√§tigkeit</th><th>Erledigt/Offen</th></tr></thead>
          <tbody></tbody></table></div>
      </div>
    </section>
    <section class="card" data-view="today" data-card="today" draggable="true">
      <h2 class="section-title">Heute f√§llig <span class="pill"><strong>HEUTE</strong><span id="today"></span></span></h2>
      <div class="bar">
        <select id="filterRoom">
          <option value="">Alle R√§ume</option>
        </select>
        <select id="filterDept">
          <option value="">Alle Abteilungen</option>
        </select>
        <select id="filterStatus">
          <option value="all">Alle Status</option>
          <option value="open">Offen</option>
          <option value="done">Erledigt</option>
        </select>
        <input type="search" id="search" placeholder="Suche..." />
      </div>
      <div class="table-wrap">
        <table id="tblToday" class="gridtable">
          <colgroup>
            <col class="c-room" />
            <col class="c-task" />
            <col class="c-int" />
            <col class="c-due" />
            <col class="c-status" />
            <col class="c-act" />
          </colgroup>
          <thead>
            <tr>
              <th>Raum</th>
              <th>T√§tigkeit</th>
              <th class="hide-sm">Intervall</th>
              <th>F√§llig am</th>
              <th>Status</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="cardsToday" class="card-list"></div>
      <div class="footer-note">‚ÄûErledigt‚Äú ist nur am heutigen Kalendertag m√∂glich.</div>
    </section>

    <aside class="card" data-view="pruefen" data-card="pruefen" draggable="true">
      <h2 class="section-title">Vers√§umt (Pr√ºfung)</h2>
      <div class="table-wrap">
        <table id="tblOverdue" class="gridtable">
          <colgroup>
            <col class="c-room" />
            <col class="c-task" />
            <col class="c-int" />
            <col class="c-due" />
            <col class="c-status" />
            <col class="c-act" />
          </colgroup>
          <thead>
            <tr>
              <th>Raum</th>
              <th>T√§tigkeit</th>
              <th class="hide-sm">Intervall</th>
              <th>F√§llig am</th>
              <th>Status</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="cardsOverdue" class="card-list"></div>
    </aside>

    <aside class="card" data-view="protokolle" data-card="protokolle" draggable="true">
      <h3 class="section-title">Best√§tigte Protokolle</h3>
      <div class="bar">
        <select id="logRoom"></select>
        <input id="logSearch" type="text" placeholder="Suche in Protokollen ‚Ä¶" />
      </div>
      <div class="table-wrap">
        <table id="tblLogs">
          <thead><tr><th>Zeit</th><th>Benutzer</th><th>Raum</th><th>T√§tigkeit</th><th>F√§lligkeits-Datum</th><th>Kommentar</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="cardsLogs" class="card-list"></div>

    </aside>

    <aside class="card" data-view="acks" data-card="acks" draggable="true">
      <h3 class="section-title">Quittierungen (Vers√§umt)</h3>
      <div class="bar">
        <select id="ackRoom"></select>
        <input id="ackSearch" type="text" placeholder="Suche in Quittierungen ‚Ä¶" />
      </div>
      <div class="table-wrap">
        <table id="tblAcks">
          <thead><tr><th>Zeit</th><th>Pr√ºfer</th><th>Raum</th><th>T√§tigkeit</th><th>F√§lligkeit</th><th>Typ</th><th>Details</th><th>Kommentar</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="cardsAcks" class="card-list"></div>
    </aside>

    <section class="card" id="admin" data-view="admin" data-card="admin" draggable="true" style="display:none">
      <h2 class="section-title">Admin</h2>
      <div id="adminGrid" class="admin-grid">
        <div class="card" data-admin-card="rooms" draggable="true">
          <h3 class="section-title">R√§ume</h3>
          <div class="bar">
            <input id="roomSearch" type="search" placeholder="Suche R√§ume ‚Ä¶" />
          </div>
          <div class="grid cols-2">
            <div><label>Name</label><input id="roomName" placeholder="z. B. Reinraum 101" /></div>
            <div><label>Ort/Notiz</label><input id="roomNote" placeholder="EG Nord" /></div>
          </div>
          <div class="bar"><button id="btnAddRoom">Raum anlegen</button></div>
          <div class="table-wrap"><table id="tblRooms"><thead><tr><th>Name</th><th>Notiz</th><th>Aktion</th></tr></thead><tbody></tbody></table></div>
        </div>
        <div class="card" data-admin-card="acts" draggable="true">
          <h3 class="section-title">T√§tigkeiten</h3>
          <div class="grid cols-3">
            <div><label>Raum</label><select id="actRoom"></select></div>
            <div><label>Abteilung</label><select id="actDept"></select></div>
            <div><label>Bezeichnung</label><input id="actTitle" placeholder="Oberfl√§chenreinigung" /></div>
            <div><label>Start</label><input id="actStart" type="date" /></div>
            <div class="grow"><label>Beschreibung</label><input id="actDesc" placeholder="Kurze Anweisung" /></div>
            <div><label>Intervall</label><select id="actType"><option value="daily">t√§glich</option><option value="weekly">w√∂chentlich</option><option value="monthly">monatlich</option><option value="quarterly">quartalsweise</option><option value="yearly">j√§hrlich</option></select></div>
            <div><label>Alle (N)</label><input id="actEvery" type="number" min="1" value="1" /></div>
            <div id="weeklyBox"><label>Wochentag</label><select id="actWeekday"><option value="1">Montag</option><option value="2">Dienstag</option><option value="3">Mittwoch</option><option value="4">Donnerstag</option><option value="5">Freitag</option><option value="6">Samstag</option><option value="7">Sonntag</option></select></div>
            <div id="monthDayBox"><label>Tag im Monat</label><input id="actMonthDay" type="number" min="1" max="31" value="1" /></div>
            <div id="yearMonthBox"><label>Monat</label><input id="actYearMonth" type="number" min="1" max="12" value="1" /></div>
          </div>
          <div class="bar"><button id="btnAddAct">T√§tigkeit anlegen</button></div>
          <div class="bar">
            <select id="actFilterRoom"><option value="">Alle R√§ume</option></select>
            <select id="actFilterDept"><option value="">Alle Abteilungen</option></select>
            <input id="actSearch" type="search" placeholder="Suche T√§tigkeiten ‚Ä¶" />
          </div>
          <div class="table-wrap"><table id="tblActs">
            <thead>
              <tr>
                <th>Raum</th>
                <th>Abteilung</th>
                <th>T√§tigkeit</th>
                <th>Intervall</th>
                <th>Start</th>
                <th>N√§chste</th>
                <th>Aktion</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table></div>
        </div>
      
      <div class="card" data-admin-card="users" draggable="true">
        <h3 class="section-title">Benutzerverwaltung</h3>
        <div class="bar">
          <select id="userRoleFilter">
            <option value="">Alle Rollen</option>
            <option value="user">User</option>
            <option value="pruefer">Pruefer</option>
            <option value="admin">Admin</option>
          </select>
          <input id="userSearch" type="search" placeholder="Suche Benutzer ‚Ä¶" />
        </div>
        <div class="grid cols-3">
          <div><label>Name</label><input id="userName" placeholder="z. B. Max Muster" /></div>
          <div><label>Rolle</label><select id="userRole"><option value="user">User</option><option value="admin">Admin</option><option value="pruefer">Pruefer</option></select></div>
          <div><label>Abteilung</label><select id="userDept"></select></div>
          <div><label>Passwort (optional)</label>
          <div class="input-group"><input id="userPass" type="password" placeholder="Passwort setzen"/><button id="btnEyeUser" class="eye-btn">üëÅ</button></div><small class="hint">Ohne Eingabe: Erst-Login mit ‚Äûtest‚Äú.</small></div>
          <div class="row" style="align-self:end; gap:8px;"><button id="btnAddUser">Benutzer anlegen</button></div>
        </div>
        <div class="table-wrap"><table id="tblUsers"><thead><tr><th>Name</th><th>Rolle</th><th>Aktion</th></tr></thead><tbody></tbody></table></div>
      </div>

      <div class="card" data-admin-card="depts" draggable="true">
        <h3 class="section-title">Abteilungen</h3>
        <div class="bar">
          <input id="deptSearch" type="search" placeholder="Suche Abteilungen ‚Ä¶" />
        </div>
        <div class="grid cols-2">
          <div><label>Name</label><input id="deptName" placeholder="z. B. Produktion" /></div>
          <div><label>Beschreibung</label><input id="deptDesc" placeholder="Kurze Beschreibung" /></div>
        </div>
        <div class="bar"><button id="btnAddDept">Abteilung anlegen</button></div>
        <div class="table-wrap">
          <table id="tblDepts">
            <thead><tr><th>Name</th><th>Beschreibung</th><th>Aktion</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      </div> <!-- /#adminGrid -->
    </section>
  </main>

  <nav class="bottom-nav" id="bottomNav" aria-label="Hauptnavigation">
    <button class="tab" data-tab="dashboard">Dashboard</button>
    <button class="tab active" data-tab="today">Heute</button>
    <button class="tab" data-tab="pruefen">Pr√ºfen</button>
    <button class="tab" data-tab="protokolle">Protokolle</button>
    <button class="tab" data-tab="acks">Quittierungen</button>
    <button class="tab" data-tab="admin">Admin</button>
  </nav>

  <div id="sheet" class="sheet hidden" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="sheet-content">
      <div class="sheet-header">
        <div class="sheet-title" id="sheetTitle">Kommentar</div>
        <button class="sheet-close ghost" id="sheetClose">Schlie√üen</button>
      </div>
      <div class="sheet-body">
        <div class="muted" id="sheetMeta"></div>
        <textarea id="sheetTextarea" class="comment-textarea" placeholder="Kommentar eingeben‚Ä¶"></textarea>
        <div id="sheetHistory" class="comment-history"></div>
      </div>
      <div class="sheet-actions">
        <button id="sheetPrimary" class="comment-btn">Speichern</button>
        <button id="sheetSecondary" class="comment-btn quit-btn" style="display:none">Quittieren</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    // Abteilungsverwaltung (mit Duplikat-Schutz und Rendering)
    const departments = {
        items: [],
        
        add(name, description) {
            const nm = String(name||'').trim();
            if (!nm) return null;
            // Duplikate vermeiden (case-insensitive)
            const existing = this.items.find(d => d.name.trim().toLowerCase() === nm.toLowerCase());
            if (existing) {
                // Beschreibung ggf. aktualisieren
                if (description && description.trim()) existing.description = description.trim();
                this.save();
                return existing;
            }
            const id = (typeof uuid === 'function') ? uuid() : (Date.now()+""+Math.random().toString(16).slice(2));
            const dept = { id, name: nm, description: (description||'').trim() };
            this.items.push(dept);
            this.save();
            return dept;
        },
        
        save() {
            localStorage.setItem('departments', JSON.stringify(this.items));
        },
        
        load() {
            const stored = localStorage.getItem('departments');
            const arr = stored ? JSON.parse(stored) : [];
            // Normalize + Duplikate nach Name entfernen
            const seen = new Set();
            this.items = arr.filter(d => d && d.name)
                .map(d => ({ id: String(d.id || (typeof uuid==='function'? uuid(): Date.now())), name: String(d.name).trim(), description: (d.description||'').trim() }))
                .filter(d => {
                    const key = d.name.toLowerCase();
                    if (seen.has(key)) return false;
                    seen.add(key); return true;
                });
            this.save();
        },
        
        delete(id) {
            this.items = this.items.filter(d => String(d.id) !== String(id));
            this.save();
        }
    };

    // Tabelle der Abteilungen rendern
    function updateDepartmentTables() {
        const tbody = document.querySelector('#tblDepts tbody');
        if (!tbody) return;
        if (!Array.isArray(departments.items)) departments.items = [];
        tbody.innerHTML = departments.items.map(d => `
            <tr id="dept-${d.id}">
              <td>${d.name}</td>
              <td class="muted">${d.description||''}</td>
              <td>
                <span class="link" data-edit-dept="${d.id}">Bearbeiten</span>
                 | <span class="dangerlink" data-del-dept="${d.id}">l√∂schen</span>
              </td>
            </tr>
        `).join('') || '<tr><td colspan="3" class="muted">Keine Abteilungen.</td></tr>';
        // Delegierter Click-Handler f√ºr Edit/L√∂schen/Speichern/Abbrechen
        if (!tbody._deptBound) {
            tbody.addEventListener('click', (e) => {
                const delEl = e.target.closest('[data-del-dept]');
                if (delEl) {
                    const id = delEl.getAttribute('data-del-dept');
                    const d = departments.items.find(x => String(x.id) === id);
                    if (!d) return;
                    if (!confirm(`Abteilung "${d.name}" wirklich l√∂schen?`)) return;
                    departments.delete(id);
                    updateDepartmentTables();
                    updateDepartmentSelects();
                    if (typeof renderAdmin === 'function') renderAdmin();
                    return;
                }
                const editEl = e.target.closest('[data-edit-dept]');
                if (editEl) {
                    const id = editEl.getAttribute('data-edit-dept');
                    const d = departments.items.find(x => String(x.id) === id);
                    if (!d) return;
                    const tr = document.getElementById(`dept-${id}`);
                    if (!tr) return;
                    const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/\"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                    tr.innerHTML = `
                      <td><input id=\"ed-name-${id}\" value=\"${esc(d.name)}\"/></td>
                      <td><input id=\"ed-desc-${id}\" value=\"${esc(d.description||'')}\"/></td>
                      <td>
                        <button class=\"small-button\" data-save-dept=\"${id}\">Speichern</button>
                        <button class=\"small-button ghost\" data-cancel-dept=\"${id}\">Abbrechen</button>
                      </td>`;
                    return;
                }
                const saveEl = e.target.closest('[data-save-dept]');
                if (saveEl) {
                    const id = saveEl.getAttribute('data-save-dept');
                    const d = departments.items.find(x => String(x.id) === id);
                    const tr = document.getElementById(`dept-${id}`);
                    if (!d || !tr) return;
                    const name = (tr.querySelector(`#ed-name-${id}`)?.value||'').trim();
                    const desc = (tr.querySelector(`#ed-desc-${id}`)?.value||'').trim();
                    if (!name) { alert('Name fehlt'); return; }
                    const exists = departments.items.find(x => String(x.id) !== id && String(x.name).trim().toLowerCase() === name.toLowerCase());
                    if (exists) { alert('Abteilung mit diesem Namen existiert bereits.'); return; }
                    d.name = name; d.description = desc; departments.save();
                    updateDepartmentTables();
                    updateDepartmentSelects();
                    if (typeof renderAdmin === 'function') renderAdmin();
                    return;
                }
                const cancelEl = e.target.closest('[data-cancel-dept]');
                if (cancelEl) {
                    updateDepartmentTables();
                    return;
                }
            });
            tbody._deptBound = true;
        }
    }

    // Hilfsfunktion zum Aktualisieren aller Abteilungs-Dropdowns
    function updateDepartmentSelects() {
        const selects = ['userDept', 'actDept'];
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            const cur = select.value;
            select.innerHTML = '<option value="">Bitte w√§hlen...</option>' +
                departments.items.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
            // Auswahl beibehalten, falls m√∂glich
            if (cur) select.value = cur;
        });
    }

    // Filtern der T√§tigkeiten nach Abteilung (falls ben√∂tigt)
    function filterActivitiesByDepartment(activities) {
        const currentUser = getCurrentUser();
        if (currentUser.role === 'admin') return activities;
        return activities.filter(activity => activity.department === currentUser.department);
    }

    // Event-Handler f√ºr ‚ÄûAbteilung anlegen‚Äú
    document.getElementById('btnAddDept').addEventListener('click', () => {
        const name = document.getElementById('deptName').value;
        const desc = document.getElementById('deptDesc').value;
        if (!name || !name.trim()) return;
        departments.add(name, desc);
        document.getElementById('deptName').value = '';
        document.getElementById('deptDesc').value = '';
        updateDepartmentTables();
        updateDepartmentSelects();
        if (typeof renderAdmin === 'function') renderAdmin();
    });

    // Beim Laden der Anwendung: Departments laden, UI aktualisieren und Admin neu rendern
    window.addEventListener('load', () => {
        departments.load();
        updateDepartmentTables();
        updateDepartmentSelects();
        if (typeof renderAdmin === 'function') renderAdmin();
    });
    // === Theme toggle (manual + system) ===
    (function(){
      const KEY = 'theme-preference'; // 'light' | 'dark' | null (auto)
      const root = document.documentElement;
      const btn  = document.getElementById('themeToggle');
      if(!btn) return; // nur ausfuehren, wenn Button existiert

      // Gespeicherte Wahl anwenden (manueller Override)
      const saved = localStorage.getItem(KEY);
      if (saved === 'dark' || saved === 'light') {
        root.setAttribute('data-theme', saved);
      } else {
        root.removeAttribute('data-theme'); // auto: folgt System
      }

      // Systemwechsel live uebernehmen, wenn kein manueller Override aktiv ist
      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      (mq.addEventListener ? mq.addEventListener('change', onSystemChange)
                           : mq.addListener && mq.addListener(onSystemChange));
      function onSystemChange(){
        if (!localStorage.getItem(KEY)) {
          root.removeAttribute('data-theme');
          setIcon(null);
        }
      }

      // Icon (Sonne/Mond) je nach aktuellem Modus setzen (nur Strichsymbole)
      function setIcon(theme){
        const isDark = theme ? theme === 'dark' : mq.matches;
        btn.innerHTML = isDark
          // Mond (Stroke-Only)
          ? '<span class="theme-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79Z"/></svg></span>'
          // Sonne (Stroke-Only)
          : '<span class="theme-icon" aria-hidden="true"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M2 12h2M20 12h2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"></path></svg></span>';
      }
      setIcon(saved);

      // Klick-Zyklus (intuitiv): dark -> light -> auto (System) -> dark -> ...
      btn.addEventListener('click', () => {
        const cur = root.getAttribute('data-theme'); // 'light' | 'dark' | null
        if (cur === 'dark') {
          // dark -> light
          root.setAttribute('data-theme','light');
          localStorage.setItem(KEY,'light');
          setIcon('light');
        } else if (cur === 'light') {
          // light -> auto (System)
          root.removeAttribute('data-theme');
          localStorage.removeItem(KEY);
          setIcon(null);
        } else {
          // auto -> dark
          root.setAttribute('data-theme','dark');
          localStorage.setItem(KEY,'dark');
          setIcon('dark');
        }
      });
    })();
  </script>
</body>
</html>
